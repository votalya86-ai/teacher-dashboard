<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Панель Учителя (Firebase)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        .session-card, .student-item { transition: all 0.3s ease; }
        #session-detail-view { display: none; }
        #dashboard-view { display: block; }
        .modal {
            transition: opacity 0.25s ease;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4 md:p-8">
        <!-- Expiry Warning Banner -->
        <div id="expiry-warning" class="hidden bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-6 rounded-lg shadow" role="alert">
            <p class="font-bold">Внимание!</p>
            <p>Тестовый доступ к вашей базе данных Firebase истекает <strong id="expiry-days-left"></strong>. Чтобы приложение продолжило работать, обновите дату в правилах безопасности в консоли Firebase.</p>
        </div>

        <!-- Dashboard View -->
        <div id="dashboard-view">
            <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8">
                <header class="flex justify-between items-center pb-4 border-b">
                    <h1 class="text-2xl md:text-3xl font-bold text-indigo-600">Панель Управления Уроками</h1>
                    <button id="create-session-btn" class="bg-blue-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-blue-700 transition-transform transform hover:scale-105">
                        + Создать сессию
                    </button>
                </header>
                <section id="sessions-list-section" class="mt-6">
                    <h2 class="text-xl font-bold mb-4">Активные сессии</h2>
                    <div id="sessions-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <p id="sessions-status-message">Загрузка сессий...</p>
                    </div>
                </section>
            </div>
        </div>

        <!-- Session Detail View -->
        <div id="session-detail-view">
            <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8">
                <header class="pb-4 border-b">
                     <button id="back-to-dashboard-btn" class="mb-4 text-sm text-indigo-600 hover:underline">&larr; Вернуться к списку сессий</button>
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                        <div>
                            <h1 id="detail-session-name" class="text-2xl md:text-3xl font-bold text-indigo-600"></h1>
                             <div class="mt-2 p-2 bg-indigo-50 border rounded-lg inline-block">
                                <span class="font-medium">ID для учеников:</span>
                                <strong id="detail-session-id" class="text-indigo-700 text-lg ml-2 select-all"></strong>
                            </div>
                        </div>
                    </div>
                </header>
                <main class="mt-6 flex flex-col md:flex-row gap-8">
                    <div class="w-full md:w-1/3">
                        <h3 class="text-lg font-bold mb-3">Управление</h3>
                        <div class="space-y-3">
                            <button id="permit-test-btn" class="w-full bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700">Разрешить тест</button>
                            <button id="delete-session-btn" class="w-full bg-red-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-700">Удалить сессию</button>
                        </div>
                    </div>
                    <div class="w-full md:w-2/3">
                        <h3 class="text-lg font-bold mb-3">Список учеников</h3>
                        <div class="bg-gray-50 rounded-lg p-4 min-h-[100px]">
                            <ul id="student-list" class="space-y-3">
                                <li id="no-students-message">Ожидание подключения учеников...</li>
                            </ul>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <!-- Modal for creating a new session -->
    <div id="create-session-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden opacity-0">
        <div class="relative mx-auto p-5 border w-full max-w-sm shadow-lg rounded-2xl bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-xl leading-6 font-bold text-gray-900">Создать новую сессию</h3>
                <div class="mt-4 px-7 py-3">
                    <input type="text" id="new-session-name-input" class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Название урока (7А - Антивирусы)">
                </div>
                <div class="items-center px-4 py-3 space-y-2">
                    <button id="confirm-create-session-btn" class="px-4 py-2 bg-blue-600 text-white text-base font-medium rounded-lg w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        Создать
                    </button>
                     <button id="cancel-create-session-btn" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-lg w-full shadow-sm hover:bg-gray-300 focus:outline-none">
                        Отмена
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, updateDoc, deleteDoc, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- PASTE YOUR FIREBASE CONFIG OBJECT HERE ---
        const firebaseConfig = {
            apiKey: "AIzaSyA6jZmqDDByFLcGKWUpLhtnLcjw6TXk4KZ4",
            authDomain: "interactive-lessons-app.firebaseapp.com",
            projectId: "interactive-lessons-app",
            storageBucket: "interactive-lessons-app.appspot.com",
            messagingSenderId: "27494371437",
            appId: "1:27494371437:web:59cde3946de4382caaf6f4"
        };
        // --- END OF FIREBASE CONFIG ---

        if (!firebaseConfig || !firebaseConfig.projectId || firebaseConfig.projectId === "...") {
            alert('Объект конфигурации Firebase не найден. Пожалуйста, следуйте инструкции по настройке.');
        }
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const dashboardView = document.getElementById('dashboard-view');
        const sessionDetailView = document.getElementById('session-detail-view');
        const createSessionBtn = document.getElementById('create-session-btn');
        const sessionsList = document.getElementById('sessions-list');
        const sessionsStatusMessage = document.getElementById('sessions-status-message');
        
        const backToDashboardBtn = document.getElementById('back-to-dashboard-btn');
        const detailSessionName = document.getElementById('detail-session-name');
        const detailSessionId = document.getElementById('detail-session-id');
        const permitTestBtn = document.getElementById('permit-test-btn');
        const deleteSessionBtn = document.getElementById('delete-session-btn');
        const studentList = document.getElementById('student-list');
        const noStudentsMessageDetail = document.getElementById('no-students-message');

        const modal = document.getElementById('create-session-modal');
        const newSessionNameInput = document.getElementById('new-session-name-input');
        const confirmCreateSessionBtn = document.getElementById('confirm-create-session-btn');
        const cancelCreateSessionBtn = document.getElementById('cancel-create-session-btn');
        
        const expiryWarningEl = document.getElementById('expiry-warning');
        const expiryDaysLeftEl = document.getElementById('expiry-days-left');

        // --- State ---
        let currentSessionId = null;
        let sessionsUnsubscribe = null;
        let studentsUnsubscribe = null;

        // --- Functions ---
        function showView(view) {
            dashboardView.style.display = 'none';
            sessionDetailView.style.display = 'none';
            view.style.display = 'block';
        }
        
        function toggleModal(show) {
            if (show) {
                modal.classList.remove('hidden');
                setTimeout(() => modal.classList.remove('opacity-0'), 10);
            } else {
                modal.classList.add('opacity-0');
                setTimeout(() => modal.classList.add('hidden'), 250);
            }
        }

        function renderDashboard(sessions) {
            sessionsList.innerHTML = '';
            if (Object.keys(sessions).length === 0) {
                 sessionsStatusMessage.textContent = 'Активных сессий нет. Нажмите "Создать сессию", чтобы начать.';
                 sessionsList.appendChild(sessionsStatusMessage);
                return;
            }
            
            Object.entries(sessions).forEach(([id, sessionData]) => {
                const card = document.createElement('div');
                card.className = 'session-card bg-white p-4 rounded-lg shadow-md border cursor-pointer hover:shadow-lg hover:border-indigo-500';
                card.dataset.sessionId = id;
                card.innerHTML = `
                    <h3 class="font-bold text-lg">${sessionData.lessonName}</h3>
                    <p class="text-sm text-gray-500">Студентов: ${sessionData.studentCount || 0}</p>
                    <p class="text-xs text-gray-400 mt-2">ID: ${id}</p>
                `;
                card.addEventListener('click', () => openSessionDetail(id, sessionData.lessonName));
                sessionsList.appendChild(card);
            });
        }
        
        function renderStudentList(students) {
            studentList.innerHTML = '';
             if (Object.keys(students).length === 0) {
                studentList.appendChild(noStudentsMessageDetail);
                return;
            }
            Object.entries(students).forEach(([name, data]) => {
                const li = document.createElement('li');
                li.className = 'student-item flex justify-between items-center bg-white p-3 rounded-lg shadow-sm border';
                const scoreText = data.score !== null ? `${data.score}/100` : 'Ожидает...';
                const scoreColor = data.score !== null ? (data.score >= 75 ? 'text-green-600' : 'text-red-600') : 'text-gray-500';
                li.innerHTML = `<span class="font-medium">${name}</span><span class="font-bold ${scoreColor}">${scoreText}</span>`;
                studentList.appendChild(li);
            });
        }
        
        async function openSessionDetail(sessionId, lessonName) {
            currentSessionId = sessionId;
            detailSessionName.textContent = lessonName;
            detailSessionId.textContent = sessionId;

            if (studentsUnsubscribe) studentsUnsubscribe();
            
            const studentsColRef = collection(db, "lessons", sessionId, "students");
            studentsUnsubscribe = onSnapshot(studentsColRef, (snapshot) => {
                const students = {};
                snapshot.forEach(doc => students[doc.id] = doc.data());
                renderStudentList(students);
            });
            showView(sessionDetailView);
        }

        function checkExpiryReminder() {
            const reminderKey = 'firebaseRulesExpiryReminder';
            let expiryTimestamp = localStorage.getItem(reminderKey);

            if (!expiryTimestamp) {
                expiryTimestamp = new Date().getTime() + 30 * 24 * 60 * 60 * 1000;
                localStorage.setItem(reminderKey, expiryTimestamp);
            }

            const daysLeft = Math.ceil((expiryTimestamp - new Date().getTime()) / (1000 * 60 * 60 * 24));

            if (daysLeft <= 5) {
                if (daysLeft > 1) expiryDaysLeftEl.textContent = `через ${daysLeft} дня`;
                else if (daysLeft === 1) expiryDaysLeftEl.textContent = `завтра`;
                else expiryDaysLeftEl.textContent = `сегодня!`;
                
                expiryWarningEl.classList.remove('hidden');
            }
        }

        // --- Event Listeners ---
        createSessionBtn.addEventListener('click', () => {
            newSessionNameInput.value = '';
            toggleModal(true);
            newSessionNameInput.focus();
        });
        
        cancelCreateSessionBtn.addEventListener('click', () => toggleModal(false));
        
        confirmCreateSessionBtn.addEventListener('click', async () => {
            const lessonName = newSessionNameInput.value.trim();
            if (lessonName === '') {
                alert("Название урока не может быть пустым.");
                return;
            }
            
            toggleModal(false);

            const sessionId = Math.random().toString(36).substring(2, 8).toUpperCase();
            const sessionDocRef = doc(db, "lessons", sessionId);
            await setDoc(sessionDocRef, {
                lessonName: lessonName,
                createdAt: new Date(),
                testPermitted: false
            });
        });
        
        backToDashboardBtn.addEventListener('click', () => {
            if (studentsUnsubscribe) studentsUnsubscribe();
            currentSessionId = null;
            showView(dashboardView);
        });

        permitTestBtn.addEventListener('click', async () => {
            if (!currentSessionId) return;
            const sessionDocRef = doc(db, "lessons", currentSessionId);
            await updateDoc(sessionDocRef, { testPermitted: true });
            alert('Разрешение на прохождение теста отправлено ученикам этой сессии.');
        });
        
        deleteSessionBtn.addEventListener('click', async () => {
            if (!currentSessionId || !confirm('Вы уверены? Это действие удалит сессию и все результаты учеников.')) return;
            
            const batch = writeBatch(db);
            const studentsColRef = collection(db, "lessons", currentSessionId, "students");
            const studentsSnapshot = await getDocs(studentsColRef);
            studentsSnapshot.forEach(doc => batch.delete(doc.ref));
            
            const sessionDocRef = doc(db, "lessons", currentSessionId);
            batch.delete(sessionDocRef);
            
            await batch.commit();
            
            backToDashboardBtn.click();
        });

        // --- Initial Load ---
        async function initializeDashboard() {
            const maxRetries = 3;
            let attempt = 1;

            while(attempt <= maxRetries) {
                try {
                    sessionsStatusMessage.textContent = 'Подключение к серверу...';
                    await signInAnonymously(auth);

                    checkExpiryReminder();
                    
                    if (sessionsUnsubscribe) sessionsUnsubscribe();
                    const sessionsColRef = collection(db, "lessons");
                    sessionsUnsubscribe = onSnapshot(sessionsColRef, async (snapshot) => {
                        let sessions = {};
                        for (const sessionDoc of snapshot.docs) {
                            const studentsColRef = collection(db, "lessons", sessionDoc.id, "students");
                            const studentsSnapshot = await getDocs(studentsColRef);
                            sessions[sessionDoc.id] = {
                                ...sessionDoc.data(),
                                studentCount: studentsSnapshot.size
                            };
                        }
                        renderDashboard(sessions);
                    });

                    return; // Success, exit function
                } catch (error) {
                    console.error(`Initialization attempt ${attempt} failed:`, error);
                    attempt++;
                    if (attempt > maxRetries) {
                        sessionsList.innerHTML = '';
                        const errorEl = document.createElement('p');
                        errorEl.className = 'text-red-600';
                        errorEl.textContent = 'Не удалось подключиться к серверу. Проверьте интернет-соединение и обновите страницу. Если проблема не исчезнет, убедитесь, что все настройки Firebase выполнены верно.';
                        sessionsList.appendChild(errorEl);
                    }
                    // Wait before retrying
                    await new Promise(res => setTimeout(res, 1500 * attempt));
                }
            }
        }

        initializeDashboard();
    </script>
</body>
</html>

